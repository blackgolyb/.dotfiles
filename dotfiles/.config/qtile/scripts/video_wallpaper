#!/bin/bash

function start_wallpapers() {
    # Get screen resolution for the specified monitor
    if [ "$2" == "right" ]; then
        # Get resolution of the right monitor (assuming it's the second one)
        resolution=$(xrandr --query | grep " connected" | sed -n '2p' | grep -oP '\d+x\d+' | head -n1)
        if [ -z "$resolution" ]; then
            # Fallback: get primary monitor resolution
            resolution=$(xrandr --query | grep " connected primary" | grep -oP '\d+x\d+' | head -n1)
        fi
        width=$(echo $resolution | cut -d'x' -f1)
        height=$(echo $resolution | cut -d'x' -f2)
        pos="${width}+0"
    else
        # Get resolution of the left/primary monitor
        resolution=$(xrandr --query | grep " connected primary" | grep -oP '\d+x\d+' | head -n1)
        if [ -z "$resolution" ]; then
            # Fallback: get first connected monitor
            resolution=$(xrandr --query | grep " connected" | head -n1 | grep -oP '\d+x\d+' | head -n1)
        fi
        width=$(echo $resolution | cut -d'x' -f1)
        height=$(echo $resolution | cut -d'x' -f2)
        pos="0+0"
    fi

    # Fallback to 1920x1200 (16:10) if detection fails
    if [ -z "$width" ] || [ -z "$height" ]; then
        width=1920
        height=1200
    fi

    echo "Starting video wallpaper with resolution: ${width}x${height} at position: $pos"
    xwinwrap -g ${width}x${height}+$pos -ni -ov -s -b -nf -debug -- mpv $1 $3 -wid WID --no-audio --hwdec=auto
}


LOCATION=0
#X, Y Offset
#This sets the distance of the window from the edge of the screen on the X and Y axis.
Y_AXIS=0
X_AXIS=0
WIDTH=10
# HEIGHT="'max-content'"
# height:$HEIGHT
STYLE="element{padding:4px4px4px0px;}listview{fixed-height:false;}"

# Rofi command to pipe into, can add any options here
rofi_command_add="-location $LOCATION -yoffset $Y_AXIS -xoffset $X_AXIS -theme-str window{width:"$WIDTH"em;}$STYLE"
rofi_command="rofi $rofi_command_add -dmenu $* -p"


function play() {
    monitor="$(echo -e "left\nright" | $rofi_command "󰍹" )"
    loop="$(echo -e "loop\nno_loop" | $rofi_command "󰍹" )"
    args=
    case $loop in
        "loop")
            args=--loop
            ;;
    esac
    url="$($rofi_command "URL" )"

    # current_monitor=$"(cat /tmp/__WM__CURRENT_MONITOR__)"

    if [ ! -z "$url" ]
    then
        start_wallpapers $url $monitor $args
    fi
}

function stop() {
    pkill xwinwrap
}


function show_menu() {
    options="play\nstop"

    chosen="$(echo -e "$options" | $rofi_command "" )"

    case $chosen in
        "play")
            play
            ;;
        "stop")
            stop
            ;;
        *)
            ;;
    esac
}


case $1 in
    "start")
        show_menu
        ;;
esac
